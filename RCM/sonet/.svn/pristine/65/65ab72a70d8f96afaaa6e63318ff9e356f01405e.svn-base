package pt.ist.sonet.service;

import pt.ist.fenixframework.FenixFramework;

import pt.ist.sonet.domain.Content;
import pt.ist.sonet.domain.SoNet;
import pt.ist.sonet.exception.AgentUsernameDoesNotExistsException;
import pt.ist.sonet.exception.PagAmigoTransferException;
import pt.ist.sonet.exception.SoNetException;
import pt.ist.sonet.service.dto.FileTransferDto;
import pt.ist.sonet.service.dto.PaymentDto;

/**
 * Implementa o servico de ver/comprar conteudos da SoNet.
 * 
 * @author ES Grupo 8
 * 
 */
public class ObtainLargaCaixaContentService extends SonetService {

	private String fromUser;
	private String toUser;
	private int pubId;
	private int price;

	/**
	 * Construtor
	 * 
	 * @param String
	 *            from
	 * @param String
	 *            to
	 * @param Integer
	 *            amount
	 * @param String
	 *            description
	 */
	public ObtainLargaCaixaContentService(String from, int pubID) {
		this.fromUser = from;
		this.pubId = pubID;
	}

	/**
	 * Faz o dispatch do servico
	 * 
	 * @throws SoNetException
	 * @throws AgentUsernameDoesNotExistsException
	 * @throws PagAmigoTransferException
	 */
	@Override
	public void dispatch() throws SoNetException,
			AgentUsernameDoesNotExistsException, PagAmigoTransferException {

		SoNet network = FenixFramework.getRoot();
		Content pub = (Content) network.getPublicationById(pubId);
		this.price = pub.getPrice();
		this.toUser = pub.getAgent().getUsername();

//		if (pub == null)
//			throw new PublicationIdDoesNotExistsException(pubId);
		if (!network.hasAgentByUsername(fromUser))
			throw new AgentUsernameDoesNotExistsException(fromUser);
		
		String url = pub.getURL();
		
//		LargaCaixaLocal larga = new LargaCaixaLocal();
//		PagAmigoLocal paga = new PagAmigoLocal();

		if(price>0){
		ProcessPaymentService payment = new ProcessPaymentService(
				new PaymentDto(fromUser, toUser, "Payment for content: "+pub.getLabel(), price));
		payment.dispatch();
		}
		
		LargaCaixaFileTransferService transfer = new LargaCaixaFileTransferService(
				new FileTransferDto(url, fromUser, toUser, "Proof of Payment"));
		transfer.dispatch();

	}
}